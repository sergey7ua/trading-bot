name: Automate Railway Deployment

on:
  schedule:
    # Запуск щоденно з понеділка по п'ятницю о 00:00 та 19:59 UTC (3:00 та 22:59 EEST)
    - cron: '0 0,19 * * 1-5'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Railway CLI
        run: |
          npm cache clean --force
          npm install -g @railway/cli@4.5.4
          railway --version
        env:
          NODE_VERSION: 20

      - name: Debug info
        run: |
          echo "Railway CLI version: $(railway --version)"
          echo "RAILWAY_TOKEN is set: ${RAILWAY_TOKEN+x}"
          npm config get registry
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Login to Railway
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "Error: RAILWAY_TOKEN is not set"
            exit 1
          fi
          echo "${{ secrets.RAILWAY_TOKEN }}" | railway login --token
        continue-on-error: true

      - name: Verify login
        run: |
          railway whoami || { echo "Login verification failed"; exit 1; }
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy service
        run: |
          CURRENT_DAY=$(date -u +%u)
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_DAY" -le 5 ] && [ "$CURRENT_HOUR" -ge 0 ] && [ "$CURRENT_HOUR" -le 19 ]; then
            railway up --service ${{ secrets.RAILWAY_SERVICE_ID }} --detach || {
              echo "Deployment failed"
              exit 1
            }
            echo "Deployment triggered successfully"
          else
            echo "Outside deployment time window (Mon-Fri, 3:00–22:59 EEST)"
            exit 0
          fi
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
