name: Automate Railway Deployment

on:
  schedule:
    # Запуск щоденно з понеділка по п'ятницю о 00:00 та 19:59 UTC (3:00 та 22:59 EEST)
    - cron: '0 0,19 * * 1-5'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug info
        run: |
          echo "RAILWAY_TOKEN is set: ${RAILWAY_TOKEN+x}"
          echo "Current UTC time: $(date -u +%H:%M)"
          echo "Current day: $(date -u +%u)"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Verify token
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "Error: RAILWAY_TOKEN is not set"
            exit 1
          fi

      - name: Deploy via Railway API
        run: |
          CURRENT_DAY=$(date -u +%u)
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_DAY" -le 5 ] && [ "$CURRENT_HOUR" -ge 0 ] && [ "$CURRENT_HOUR" -le 19 ]; then
            curl --request POST \
              --url https://backboard.railway.app/graphql/v2 \
              --header "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data '{"query":"mutation ServiceInstanceRedeploy { serviceInstanceRedeploy(environmentId: \"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\", serviceId: \"${{ secrets.RAILWAY_SERVICE_ID }}\") }"}' \
              || { echo "API deployment failed"; exit 1; }
            echo "Deployment triggered successfully via API"
          else
            echo "Outside deployment time window (Mon-Fri, 3:00–22:59 EEST)"
            exit 0
          fi
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
