name: Automate Railway Deployment

on:
  schedule:
    # Запуск щоденно з понеділка по п'ятницю о 00:00 та 19:59 UTC (3:00 та 22:59 EEST)
    - cron: '0 0,19 * * 1-5'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Railway CLI
        run: |
          npm install -g @railway/cli@latest
          railway --version
        env:
          NODE_VERSION: 20 # Вказуємо стабільну версію Node.js для npm

      - name: Login to Railway
        run: railway login --token ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true # Продовжуємо, якщо логін не вдався, для логування помилки

      - name: Deploy service
        run: |
          # Перевіряємо день тижня та час (3:00–22:59 EEST, тобто 0:00–19:59 UTC)
          CURRENT_DAY=$(date -u +%u)
          CURRENT_HOUR=$(date -u +%H)
          if [ "$CURRENT_DAY" -le 5 ] && [ "$CURRENT_HOUR" -ge 0 ] && [ "$CURRENT_HOUR" -le 19 ]; then
            railway up --service ${{ secrets.RAILWAY_SERVICE_ID }} --detach || {
              echo "Deployment failed"
              exit 1
            }
            echo "Deployment triggered successfully"
          else
            echo "Outside deployment time window (Mon-Fri, 3:00–22:59 EEST)"
            exit 0
          fi
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_ENVIRONMENT_ID: ${{ secrets.RAILWAY_ENVIRONMENT_ID }}
